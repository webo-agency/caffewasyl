(function(f){var h=0,b;var e=function(n){return n.is(".processing")||n.parents(".processing").length};var d=function(){f("#wooccm_modal").addClass("processing")};var g=function(){f("#wooccm_modal").removeClass("processing")};_.mixin({sortOptions:function(n){return _.sortBy(n,function(p){return p.order})}});var c=Backbone.View.extend({templates:{},initialize:function(){this.templates.window=wp.template("wooccm-modal-tabs")},render:function(){this.$el.html(this.templates.window(this.model.attributes));this.$el.trigger("wooccm-tab-panels")}});var l=Backbone.View.extend({templates:{},initialize:function(){this.templates.window=wp.template("wooccm-modal-datepicker-limit")},render:function(){this.$el.html(this.templates.window(this.model.attributes));this.$el.trigger("wooccm-enhanced-between-dates");this.$el.trigger("init_tooltips")}});var m=Backbone.View.extend({templates:{},initialize:function(){this.templates.window=wp.template("wooccm-modal-panels")},render:function(){this.$el.html(this.templates.window(this.model.attributes));this.$el.trigger("wooccm-enhanced-options");this.$el.trigger("wooccm-enhanced-select");this.$el.trigger("init_tooltips")}});var k=Backbone.View.extend({templates:{},initialize:function(){this.templates.window=wp.template("wooccm-modal-info")},render:function(){this.$el.html(this.templates.window(this.model.attributes));this.$el.trigger("wooccm-enhanced-select");this.$el.trigger("init_tooltips")}});var j=Backbone.View.extend({events:{"change input":"enable","change textarea":"enable","change select":"enable","click .media-modal-backdrop":"close","click .media-modal-close":"close","click .media-modal-prev":"edit","click .media-modal-next":"edit","change .media-modal-change":"change","change .media-modal-parent":"parent","change .media-modal-render-tabs":"renderTabs","change .media-modal-render-panels":"renderPanels","change .media-modal-render-info":"renderInfo","change .media-modal-render-datepicker-limit":"renderDate","submit .media-modal-form":"submit",},templates:{},initialize:function(){_.bindAll(this,"open","edit","parent","change","load","render","close","submit");this.init();this.open()},init:function(){this.templates.window=wp.template("wooccm-modal-main")},assign:function(o,n){o.setElement(this.$(n)).render()},render:function(){var n=this;n.$el.html(n.templates.window(n.model.attributes));this.tabs=new c({model:n.model});this.panels=new m({model:n.model});this.datepickerLimit=new l({model:n.model});this.info=new k({model:n.model});this.assign(this.tabs,"#wooccm-modal-tabs");this.assign(this.panels,"#wooccm-modal-panels");this.assign(this.datepickerLimit,"#wooccm-modal-datepicker-limit");this.assign(this.info,"#wooccm-modal-info")},load:function(){var n=this;d();f.ajax({url:wooccm_field.ajax_url,data:{action:"wooccm_load_field",nonce:wooccm_field.nonce,field_id:this.model.attributes.id},dataType:"json",type:"POST",beforeSend:function(){},complete:function(){g()},error:function(){alert("Error!")},success:function(o){if(o.success){n.model.set(o.data);n.render()}else{alert(o.data)}}})},edit:function(r){r.preventDefault();var p=this,q=f(r.target),o=parseInt(f(".wc_gateways tr[data-field_id]").length),n=parseInt(p.model.get("order"));h++;if(b){clearTimeout(b)}b=setTimeout(function(){if(q.hasClass("media-modal-next")){n=Math.min(n+h,o)}else{n=Math.max(n-h,1)}p.model.set({id:parseInt(f(".wc_gateways tr[data-field_order="+n+"]").data("field_id"))});h=0;p.load()},300)},open:function(n){this.load();f("body").addClass("modal-open").append(this.$el)},update:function(q){q.preventDefault();var o=f(q.target),n=o.attr("name"),p=o.val();if(q.target.type==="checkbox"){p=o.prop("checked")===true?1:0}this.model.attributes[n]=p;this.model.changed[n]=p},change:function(n){n.preventDefault();this.update(n);this.enable()},renderTabs:function(){this.tabs.render()},renderPanels:function(){this.panels.render()},renderInfo:function(){this.info.render()},renderDate:function(){this.assign(this.datepickerLimit,"#wooccm-modal-datepicker-limit");this.datepickerLimit.render()},close:function(n){n.preventDefault();this.undelegateEvents();f(document).off("focusin");f("body").removeClass("modal-open");this.remove()},parent:function(q){q.preventDefault();var p=this,o=p.$el.find("#wooccm_modal"),n=o.find(".attachment-details");this.update(q);f.ajax({url:wooccm_field.ajax_url,data:{action:"wooccm_load_parent",nonce:wooccm_field.nonce,conditional_parent_key:p.model.attributes.conditional_parent_key},dataType:"json",type:"POST",beforeSend:function(){f(".media-modal-submit").attr("disabled",true);n.addClass("save-waiting")},complete:function(){n.addClass("save-complete");n.removeClass("save-waiting")},error:function(){alert("Error!")},success:function(r){if(r.success){p.model.attributes.parent=r.data;p.model.changed.parent=r.data;p.renderInfo()}else{alert(r.data)}}});return false},reload:function(n){if(this.$el.find("#wooccm_modal").hasClass("reload")){location.reload();return}this.remove();return},close:function(n){n.preventDefault();this.undelegateEvents();f(document).off("focusin");f("body").removeClass("modal-open");this.reload(n);return},enable:function(n){f(".media-modal-submit").removeProp("disabled")},submit:function(q){q.preventDefault();var p=this,o=p.$el.find("#wooccm_modal"),n=o.find(".attachment-details");f.ajax({url:wooccm_field.ajax_url,data:{action:"wooccm_save_field",nonce:wooccm_field.nonce,field_id:p.model.attributes.id,field_data:f("form",this.$el).serialize()},dataType:"json",type:"POST",beforeSend:function(){f(".media-modal-submit").prop("disabled",true);n.addClass("save-waiting");d()},complete:function(){n.addClass("save-complete");n.removeClass("save-waiting");g()},error:function(){alert("Error!")},success:function(r){if(r.success){if(p.model.attributes.id==undefined){o.addClass("reload");p.close(q)}p.model.set(r.data)}else{alert(r.data)}}});return false}});var i=Backbone.Model.extend({defaults:wooccm_field.args});var a=Backbone.View.extend({initialize:function(q){var p=f(q.target),o=p.closest("[data-field_id]").data("field_id");var n=new i();n.set({id:o});new j({model:n}).render()},});f("#wooccm_billing_settings_add, #wooccm_shipping_settings_add, #wooccm_additional_settings_add").on("click",function(n){n.preventDefault();new a(n)});f("#wooccm_billing_settings_reset, #wooccm_shipping_settings_reset, #wooccm_additional_settings_reset").on("click",function(o){o.preventDefault();var n=f(o.target);var p=confirm(wooccm_field.message.reset);if(!p){return false}f.ajax({url:wooccm_field.ajax_url,data:{action:"wooccm_reset_fields",nonce:wooccm_field.nonce},dataType:"json",type:"POST",beforeSend:function(){},complete:function(){},error:function(){alert("Error!")},success:function(q){if(q.success){location.reload()}else{alert(q.data)}}});return false});f(".wooccm_billing_settings_edit, .wooccm_shipping_settings_edit, .wooccm_additional_settings_edit").on("click",function(n){n.preventDefault();new a(n)});f(".wooccm_billing_settings_delete, .wooccm_shipping_settings_delete, .wooccm_additional_settings_delete").on("click",function(q){q.preventDefault();var p=f(q.target),o=p.closest("[data-field_id]"),n=o.data("field_id");var r=confirm(wooccm_field.message.remove);if(!r){return false}f.ajax({url:wooccm_field.ajax_url,data:{action:"wooccm_delete_field",nonce:wooccm_field.nonce,field_id:n,},dataType:"json",type:"POST",beforeSend:function(){},complete:function(){},error:function(){alert("Error!")},success:function(s){if(s.success){o.remove()}else{alert(s.data)}}});return false});f(document).on("click",".wooccm-field-toggle-attribute",function(q){q.preventDefault();var n=f(this),p=n.closest("tr"),o=n.find(".woocommerce-input-toggle");f.ajax({url:wooccm_field.ajax_url,data:{action:"wooccm_toggle_field_attribute",nonce:wooccm_field.nonce,field_attr:f(this).data("field_attr"),field_id:p.data("field_id")},dataType:"json",type:"POST",beforeSend:function(r){o.addClass("woocommerce-input-toggle--loading")},success:function(r){if(true===r.data){o.removeClass("woocommerce-input-toggle--enabled, woocommerce-input-toggle--disabled");o.addClass("woocommerce-input-toggle--enabled");o.removeClass("woocommerce-input-toggle--loading")}else{if(true!==r.data){o.removeClass("woocommerce-input-toggle--enabled, woocommerce-input-toggle--disabled");o.addClass("woocommerce-input-toggle--disabled");o.removeClass("woocommerce-input-toggle--loading")}}}});return false});f(document).on("change",".wooccm-field-change-attribute",function(p){p.preventDefault();var n=f(this),o=n.closest("tr");f.ajax({url:wooccm_field.ajax_url,data:{action:"wooccm_change_field_attribute",nonce:wooccm_field.nonce,field_attr:n.data("field_attr"),field_value:n.val(),field_id:o.data("field_id"),},dataType:"json",type:"POST",beforeSend:function(q){n.prop("disabled",true)},success:function(q){console.log(q.data)},complete:function(q){n.prop("disabled",false)},});return false})})(jQuery);